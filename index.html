<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toast ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ãƒã‚§ãƒƒã‚«ãƒ¼ (æ¯”è¼ƒå¯¾å¿œç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Toast ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ãƒã‚§ãƒƒã‚«ãƒ¼</h1>
            <p class="text-gray-600">PCç‰ˆã¨SPç‰ˆã®æ¯”è¼ƒåˆ†æã«å¯¾å¿œ</p>
        </div>

        <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ -->
        <div id="setupScreen" class="bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-semibold mb-6">âš™ï¸ è¨­å®š</h2>

            <div id="errorMessage" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-800 font-semibold mb-2"></p>
                <details class="text-sm text-red-700">
                    <summary class="cursor-pointer hover:underline">è©³ç´°ã‚¨ãƒ©ãƒ¼æƒ…å ±</summary>
                    <pre id="errorDetails" class="mt-2 p-2 bg-red-100 rounded overflow-auto text-xs"></pre>
                </details>
            </div>

            <!-- åˆ†æãƒ¢ãƒ¼ãƒ‰é¸æŠ -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 class="font-semibold text-blue-900 mb-3">åˆ†æãƒ¢ãƒ¼ãƒ‰</h3>
                <div class="space-y-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="analysisMode" value="single" checked onchange="updateAnalysisMode()" class="mr-2">
                        <span class="text-gray-700">å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æï¼ˆPCç‰ˆã®ã¿ or SPç‰ˆã®ã¿ï¼‰</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="analysisMode" value="compare" onchange="updateAnalysisMode()" class="mr-2">
                        <span class="text-gray-700">æ¯”è¼ƒåˆ†æï¼ˆPCç‰ˆ vs SPç‰ˆï¼‰</span>
                    </label>
                </div>
            </div>

            <div class="space-y-6">
                <!-- å…±é€šè¨­å®š -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Figma Personal Access Token
                    </label>
                    <input
                        type="password"
                        id="figmaToken"
                        placeholder="figd_..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                    <p class="mt-1 text-sm text-gray-500">
                        <span class="text-green-600 ml-2" id="figmaTokenSaved"></span>
                    </p>
                </div>

                <!-- PCç‰ˆè¨­å®š -->
                <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <h3 class="font-semibold text-purple-900 mb-3">ğŸ–¥ï¸ PCç‰ˆ</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Figma File Key (PCç‰ˆ)
                            </label>
                            <input
                                type="text"
                                id="figmaFileKeyPC"
                                placeholder="ABC123xyz..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                            <p class="mt-1 text-sm text-gray-500">
                                <span class="text-green-600 ml-2" id="figmaFileKeyPCSaved"></span>
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                å¯¾è±¡ãƒšãƒ¼ã‚¸åï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                            </label>
                            <input
                                type="text"
                                id="targetPageNamePC"
                                placeholder="ä¾‹: Toast Components - PC"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                            />
                        </div>
                    </div>
                </div>

                <!-- SPç‰ˆè¨­å®šï¼ˆæ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
                <div id="spSection" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h3 class="font-semibold text-green-900 mb-3">ğŸ“± SPç‰ˆ</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Figma File Key (SPç‰ˆ)
                            </label>
                            <input
                                type="text"
                                id="figmaFileKeySP"
                                placeholder="XYZ789abc..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            />
                            <p class="mt-1 text-sm text-gray-500">
                                <span class="text-green-600 ml-2" id="figmaFileKeySPSaved"></span>
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                å¯¾è±¡ãƒšãƒ¼ã‚¸åï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                            </label>
                            <input
                                type="text"
                                id="targetPageNameSP"
                                placeholder="ä¾‹: Toast Components - SP"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg"
                            />
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Anthropic API Key
                    </label>
                    <input
                        type="password"
                        id="anthropicKey"
                        placeholder="sk-ant-..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                    <p class="mt-1 text-sm text-gray-500">
                        <span class="text-green-600 ml-2" id="anthropicKeySaved"></span>
                    </p>
                </div>

                <button
                    onclick="startAnalysis()"
                    class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-indigo-700 transition"
                >
                    ğŸ” åˆ†æé–‹å§‹
                </button>

                <button
                    onclick="clearSavedKeys()"
                    class="w-full bg-gray-100 text-gray-600 py-2 px-4 rounded-lg text-sm hover:bg-gray-200 transition mt-2"
                >
                    ğŸ—‘ï¸ ä¿å­˜ã•ã‚ŒãŸã‚­ãƒ¼æƒ…å ±ã‚’å‰Šé™¤
                </button>
            </div>
        </div>

        <!-- å‡¦ç†ä¸­ç”»é¢ -->
        <div id="processingScreen" class="hidden bg-white rounded-lg shadow-lg p-8">
            <div class="text-center">
                <div class="mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-indigo-100 rounded-full mb-4">
                        <div class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                    <h2 class="text-2xl font-semibold mb-2">å‡¦ç†ä¸­...</h2>
                    <p id="currentTask" class="text-gray-600">æº–å‚™ä¸­...</p>
                </div>

                <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                    <div id="progressBar" class="bg-indigo-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-gray-500">0%</p>
            </div>
        </div>

        <!-- çµæœç”»é¢ -->
        <div id="resultsScreen" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-semibold">ğŸ“Š åˆ†æçµæœ</h2>
                        <p id="resultsSummary" class="text-gray-600 mt-1"></p>
                    </div>
                    <button
                        onclick="downloadReport()"
                        class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-700 transition"
                    >
                        ğŸ“¥ ãƒ¬ãƒãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>

                <!-- æ¯”è¼ƒã‚µãƒãƒªãƒ¼ï¼ˆæ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ï¼‰ -->
                <div id="comparisonSummary" class="hidden mb-6"></div>

                <div id="resultsContainer" class="space-y-4"></div>

                <button
                    onclick="resetApp()"
                    class="mt-6 w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-lg font-medium hover:bg-gray-300 transition"
                >
                    ğŸ”„ æ–°ã—ã„åˆ†æã‚’é–‹å§‹
                </button>
            </div>
        </div>
    </div>

    <script>
        const PROXY_URL = 'http://localhost:3000';
        let analysisResults = [];
        let comparisonMode = false;

        const TOAST_GUIDELINES = `# Toast ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

## æ¦‚è¦
Toast ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæ¥­ã‚’ä¸­æ–­ã—ãªã„è»½é‡ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã€ã®ãŸã‚ã®é€šçŸ¥ã§ã™ã€‚

## ä½¿ã„åˆ†ã‘ï¼ˆã„ã¤ Toast / ã„ã¤åˆ¥ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰

### Toast ãŒé©åˆ‡
â‘ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ç³»
- ãƒ•ã‚©ãƒ¼ãƒ ä¿å­˜ï¼ˆDB æ›´æ–°ï¼‰
- è¨­å®šå¤‰æ›´ã®ä¿å­˜
- ä¸‹æ›¸ãä¿å­˜ï¼ˆã‚µãƒ¼ãƒãƒ¼ or ãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆå…¬é–‹ / éå…¬é–‹ åˆ‡ã‚Šæ›¿ãˆï¼‰

â‘¡DB ã‚’ä¼´ã‚ãªã„ãŒ Toast ãŒé©åˆ‡ãªã‚±ãƒ¼ã‚¹
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå†…å®Œçµã®æ“ä½œ
- ã‚³ãƒ”ãƒ¼å®Œäº†
- ä¸¦ã³æ›¿ãˆãƒ»è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
- ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨

éåŒæœŸå‡¦ç†ã®å®Œäº†é€šçŸ¥
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†å®Œäº†
- ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†

ä¸€æ™‚çš„ãƒ»å¯é€†çš„ãªæ“ä½œçµæœ
- ã€Œå…ƒã«æˆ»ã™ã€å¯èƒ½ãªå‰Šé™¤
- ä¸€æ‹¬æ“ä½œã®å®Œäº†
- è»½å¾®ãªå¤±æ•—

### Toast ãŒä¸é©åˆ‡
- é‡å¤§ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ‡ãƒ¼ã‚¿æå¤±ãƒ»èª²é‡‘ãƒ»æ¨©é™ãªã©ï¼‰â†’ Dialog
- ç¶™ç¶šçš„ã«è¦‹ã›ãŸã„å‘ŠçŸ¥ â†’ Banner
- ã‚¿ã‚¹ã‚¯ã®é€²æ—ã‚’è¿½ã† â†’ Progress / Inline status

## ç¨®é¡
- Defaultï¼šè£œè¶³ãƒ»çŠ¶æ…‹é€šçŸ¥
- Successï¼šå®Œäº†ãƒ»æˆåŠŸ
- Warningï¼šæ³¨æ„ãƒ»æ¡ä»¶ä¸è¶³
- Errorï¼šå¤±æ•—ãƒ»ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼

## æ§‹æˆ
- Containerï¼ˆèƒŒæ™¯ / è§’ä¸¸ / å½±ï¼‰
- Status Iconï¼ˆä»»æ„ã ãŒæ¨å¥¨ï¼‰
- Text blockï¼ˆTitle / Messageï¼‰
- Actionï¼ˆä»»æ„ï¼šæœ€å¤§1ã¤ï¼‰
- Closeï¼ˆä»»æ„ï¼šÃ—ï¼‰

## ã‚µã‚¤ã‚º & ã‚¹ãƒšãƒ¼ã‚·ãƒ³ã‚°
- æœ€å°é«˜ã•ï¼š56px
- å·¦å³ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼š12â€“16px
- ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆé–“ï¼š8px
- è§’ä¸¸ï¼š8â€“12px
- æœ€å¤§å¹…ï¼šDesktop 360â€“420pxã€Mobile ç”»é¢å¹… âˆ’ 32px

## NGãƒ‘ã‚¿ãƒ¼ãƒ³
- 3ã¤ä»¥ä¸Šã®Actionã‚’ä¸¦ã¹ã‚‹
- 3è¡Œä»¥ä¸Šã®é•·æ–‡
- ç”»é¢ä¸­å¤®ã«å‡ºã—ã¦æ“ä½œã‚’é‚ªé­”ã™ã‚‹`;

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function updateAnalysisMode() {
            const mode = document.querySelector('input[name="analysisMode"]:checked').value;
            comparisonMode = (mode === 'compare');
            document.getElementById('spSection').classList.toggle('hidden', !comparisonMode);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ã•ã‚ŒãŸå€¤ã‚’å¾©å…ƒ
        window.addEventListener('DOMContentLoaded', () => {
            const keys = ['figmaToken', 'figmaFileKeyPC', 'figmaFileKeySP', 'anthropicKey'];
            keys.forEach(key => {
                const saved = localStorage.getItem(key);
                const element = document.getElementById(key);
                if (saved && element) {
                    element.value = saved;
                    const savedIndicator = document.getElementById(key + 'Saved');
                    if (savedIndicator) savedIndicator.textContent = 'âœ“ ä¿å­˜æ¸ˆã¿';
                }
            });
        });

        function saveKeys() {
            const keys = {
                figmaToken: document.getElementById('figmaToken').value.trim(),
                figmaFileKeyPC: document.getElementById('figmaFileKeyPC').value.trim(),
                figmaFileKeySP: document.getElementById('figmaFileKeySP').value.trim(),
                anthropicKey: document.getElementById('anthropicKey').value.trim()
            };
            Object.entries(keys).forEach(([key, value]) => {
                if (value) localStorage.setItem(key, value);
            });
        }

        function clearSavedKeys() {
            if (confirm('ä¿å­˜ã•ã‚ŒãŸã‚­ãƒ¼æƒ…å ±ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                ['figmaToken', 'figmaFileKeyPC', 'figmaFileKeySP', 'anthropicKey'].forEach(key => {
                    localStorage.removeItem(key);
                    const element = document.getElementById(key);
                    if (element) element.value = '';
                });
                alert('ä¿å­˜ã•ã‚ŒãŸã‚­ãƒ¼æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        function showError(message, details = null) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.querySelector('p').textContent = message;
            if (details) {
                document.getElementById('errorDetails').textContent = JSON.stringify(details, null, 2);
            }
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function updateProgress(percent, task) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = Math.round(percent) + '%';
            document.getElementById('currentTask').textContent = task;
        }

        function switchScreen(screen) {
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('processingScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById(screen + 'Screen').classList.remove('hidden');
        }

        async function fetchFigmaComponents(fileKey, targetPage, figmaToken) {
            const response = await fetch(
                `${PROXY_URL}/api/figma/files/${fileKey}?depth=2&geometry=paths`,
                { headers: { 'X-Figma-Token': figmaToken } }
            );

            if (!response.ok) {
                throw new Error(`Figmaãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã«å¤±æ•—: ${response.status}`);
            }

            const fileData = await response.json();
            
            if (fileData.err || fileData.error) {
                throw new Error(`Figma API ã‚¨ãƒ©ãƒ¼: ${fileData.err || fileData.error}`);
            }

            if (!fileData.document) {
                throw new Error('Figmaãƒ•ã‚¡ã‚¤ãƒ«ã®documentãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            const findToasts = (node, results = [], target = null) => {
                if (!node) return results;
                if (target && node.type === 'CANVAS' && node.name !== target) return results;
                if (node.type === 'CANVAS') console.log(`ãƒšãƒ¼ã‚¸æ¤œç´¢ä¸­: ${node.name}`);
                
                if (node.name && typeof node.name === 'string' && node.name.toLowerCase().includes('toast')) {
                    results.push({ id: node.id, name: node.name });
                    console.log(`ç™ºè¦‹: ${node.name}`);
                }
                
                if (Array.isArray(node.children)) {
                    node.children.forEach(child => findToasts(child, results, target));
                }
                
                return results;
            };

            const toasts = findToasts(fileData.document, [], targetPage || null);
            
            if (toasts.length === 0) {
                throw new Error('Toastã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }

            return { toasts, fileKey };
        }

        async function analyzeImage(imageData, imageName, anthropicKey, platform = '') {
            const response = await fetch(`${PROXY_URL}/api/claude`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": anthropicKey
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 2000,
                    messages: [{
                        role: "user",
                        content: [
                            {
                                type: "image",
                                source: {
                                    type: "base64",
                                    media_type: "image/png",
                                    data: imageData
                                }
                            },
                            {
                                type: "text",
                                text: `${platform ? `[${platform}ç‰ˆ] ` : ''}ä»¥ä¸‹ã®Toastã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«åŸºã¥ã„ã¦ã€æ·»ä»˜ç”»åƒã®Toastãƒ‡ã‚¶ã‚¤ãƒ³ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

${TOAST_GUIDELINES}

# åˆ†æé …ç›®
1. ä½¿ç”¨å ´é¢ã®é©åˆ‡æ€§
2. ç¨®é¡ã®é©åˆ‡æ€§
3. æ§‹æˆè¦ç´ 
4. ã‚µã‚¤ã‚ºä»•æ§˜
5. NGãƒ‘ã‚¿ãƒ¼ãƒ³

# å‡ºåŠ›å½¢å¼ï¼ˆå¿…ãšJSONå½¢å¼ã§ï¼‰
\`\`\`json
{
  "component_name": "${imageName}",
  "compliance_score": 85,
  "usage_context_appropriate": "é©åˆ‡",
  "type_detected": "Success",
  "violations": [],
  "recommendations": [],
  "summary": "ç·åˆè©•ä¾¡"
}
\`\`\``
                            }
                        ]
                    }]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Claude API ã‚¨ãƒ©ãƒ¼: ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();
            const text = data.content[0].text;
            console.log('Claude APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', text.substring(0, 100));
            
            const jsonMatch = text.match(/```json\n([\s\S]*?)\n```/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[1]);
            }
            return JSON.parse(text);
        }

        async function startAnalysis() {
            const figmaToken = document.getElementById('figmaToken').value.trim();
            const figmaFileKeyPC = document.getElementById('figmaFileKeyPC').value.trim();
            const anthropicKey = document.getElementById('anthropicKey').value.trim();

            if (!figmaToken || !figmaFileKeyPC || !anthropicKey) {
                showError('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (comparisonMode) {
                const figmaFileKeySP = document.getElementById('figmaFileKeySP').value.trim();
                if (!figmaFileKeySP) {
                    showError('æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ã§ã¯SPç‰ˆã®File Keyã‚‚å¿…è¦ã§ã™');
                    return;
                }
            }

            saveKeys();
            hideError();
            switchScreen('processing');
            updateProgress(0, 'æº–å‚™ä¸­...');

            try {
                // PCç‰ˆã‚’å–å¾—
                updateProgress(10, 'PCç‰ˆã‚’å–å¾—ä¸­...');
                const targetPagePC = document.getElementById('targetPageNamePC').value.trim();
                const pcData = await fetchFigmaComponents(figmaFileKeyPC, targetPagePC, figmaToken);
                
                let spData = null;
                if (comparisonMode) {
                    updateProgress(20, 'SPç‰ˆã‚’å–å¾—ä¸­...');
                    const figmaFileKeySP = document.getElementById('figmaFileKeySP').value.trim();
                    const targetPageSP = document.getElementById('targetPageNameSP').value.trim();
                    spData = await fetchFigmaComponents(figmaFileKeySP, targetPageSP, figmaToken);
                }

                // ç”»åƒURLå–å¾—
                const pcIds = pcData.toasts.map(t => t.id).join(',');
                const pcImagesResponse = await fetch(
                    `${PROXY_URL}/api/figma/images/${pcData.fileKey}?ids=${pcIds}&format=png&scale=2`,
                    { headers: { 'X-Figma-Token': figmaToken } }
                );
                const pcImages = (await pcImagesResponse.json()).images;

                let spImages = null;
                if (spData) {
                    const spIds = spData.toasts.map(t => t.id).join(',');
                    const spImagesResponse = await fetch(
                        `${PROXY_URL}/api/figma/images/${spData.fileKey}?ids=${spIds}&format=png&scale=2`,
                        { headers: { 'X-Figma-Token': figmaToken } }
                    );
                    spImages = (await spImagesResponse.json()).images;
                }

                // åˆ†æ
                analysisResults = [];
                const totalCount = pcData.toasts.length + (spData ? spData.toasts.length : 0);
                let currentIndex = 0;

                // PCç‰ˆåˆ†æ
                for (const toast of pcData.toasts) {
                    try {
                        currentIndex++;
                        updateProgress(30 + (60 * currentIndex / totalCount), `PCç‰ˆåˆ†æä¸­: ${toast.name} (${currentIndex}/${totalCount})`);
                        
                        const imageUrl = pcImages[toast.id];
                        if (!imageUrl) continue;

                        const imgResponse = await fetch(imageUrl);
                        const imgBlob = await imgResponse.blob();
                        const base64 = await new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result.split(',')[1]);
                            reader.readAsDataURL(imgBlob);
                        });

                        const analysis = await analyzeImage(base64, toast.name, anthropicKey, 'PC');
                        analysisResults.push({
                            platform: 'PC',
                            name: toast.name,
                            imageUrl: imageUrl,
                            analysis: analysis
                        });

                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } catch (error) {
                        console.error(`ã‚¨ãƒ©ãƒ¼: ${toast.name}`, error);
                        analysisResults.push({
                            platform: 'PC',
                            name: toast.name,
                            imageUrl: pcImages[toast.id],
                            analysis: { error: error.message, compliance_score: 0 }
                        });
                    }
                }

                // SPç‰ˆåˆ†æ
                if (spData) {
                    for (const toast of spData.toasts) {
                        try {
                            currentIndex++;
                            updateProgress(30 + (60 * currentIndex / totalCount), `SPç‰ˆåˆ†æä¸­: ${toast.name} (${currentIndex}/${totalCount})`);
                            
                            const imageUrl = spImages[toast.id];
                            if (!imageUrl) continue;

                            const imgResponse = await fetch(imageUrl);
                            const imgBlob = await imgResponse.blob();
                            const base64 = await new Promise(resolve => {
                                const reader = new FileReader();
                                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                                reader.readAsDataURL(imgBlob);
                            });

                            const analysis = await analyzeImage(base64, toast.name, anthropicKey, 'SP');
                            analysisResults.push({
                                platform: 'SP',
                                name: toast.name,
                                imageUrl: imageUrl,
                                analysis: analysis
                            });

                            await new Promise(resolve => setTimeout(resolve, 1000));
                        } catch (error) {
                            console.error(`ã‚¨ãƒ©ãƒ¼: ${toast.name}`, error);
                            analysisResults.push({
                                platform: 'SP',
                                name: toast.name,
                                imageUrl: spImages[toast.id],
                                analysis: { error: error.message, compliance_score: 0 }
                            });
                        }
                    }
                }

                updateProgress(100, 'åˆ†æå®Œäº†ï¼');
                displayResults();

            } catch (err) {
                switchScreen('setup');
                showError(err.message, { error: err.message });
            }
        }

        function displayResults() {
            switchScreen('results');

            const pcResults = analysisResults.filter(r => r.platform === 'PC');
            const spResults = analysisResults.filter(r => r.platform === 'SP');

            // ã‚µãƒãƒªãƒ¼
            let summaryText = `PCç‰ˆ: ${pcResults.length}ä»¶`;
            if (comparisonMode) {
                summaryText += `, SPç‰ˆ: ${spResults.length}ä»¶`;
            }
            document.getElementById('resultsSummary').textContent = summaryText;

            // æ¯”è¼ƒã‚µãƒãƒªãƒ¼
            if (comparisonMode) {
                const comparisonDiv = document.getElementById('comparisonSummary');
                comparisonDiv.classList.remove('hidden');
                
                // åå‰ã§ãƒãƒƒãƒãƒ³ã‚°
                const pcNames = new Set(pcResults.map(r => r.name));
                const spNames = new Set(spResults.map(r => r.name));
                const commonNames = [...pcNames].filter(name => spNames.has(name));
                const pcOnly = [...pcNames].filter(name => !spNames.has(name));
                const spOnly = [...spNames].filter(name => !pcNames.has(name));

                comparisonDiv.innerHTML = `
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h3 class="font-semibold text-blue-900 mb-2">ğŸ” æ¯”è¼ƒã‚µãƒãƒªãƒ¼</h3>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li>âœ… ä¸¡æ–¹ã«å­˜åœ¨: ${commonNames.length}ä»¶</li>
                            <li>ğŸ–¥ï¸ PCç‰ˆã®ã¿: ${pcOnly.length}ä»¶ ${pcOnly.length > 0 ? `(${pcOnly.join(', ')})` : ''}</li>
                            <li>ğŸ“± SPç‰ˆã®ã¿: ${spOnly.length}ä»¶ ${spOnly.length > 0 ? `(${spOnly.join(', ')})` : ''}</li>
                        </ul>
                    </div>
                `;
            }

            // çµæœè¡¨ç¤º
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            if (comparisonMode) {
                // æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ï¼šãƒšã‚¢ã§è¡¨ç¤º
                const pcNames = new Set(pcResults.map(r => r.name));
                const spNames = new Set(spResults.map(r => r.name));
                const allNames = new Set([...pcNames, ...spNames]);

                allNames.forEach(name => {
                    const pcResult = pcResults.find(r => r.name === name);
                    const spResult = spResults.find(r => r.name === name);

                    const card = document.createElement('div');
                    card.className = 'border-2 border-gray-300 rounded-lg p-6';
                    
                    let cardHTML = `<h3 class="text-xl font-bold mb-4">${name}</h3><div class="grid grid-cols-2 gap-6">`;

                    // PCç‰ˆ
                    cardHTML += '<div class="border-l-4 border-purple-500 pl-4">';
                    cardHTML += '<h4 class="font-semibold text-purple-700 mb-2">ğŸ–¥ï¸ PCç‰ˆ</h4>';
                    if (pcResult) {
                        cardHTML += createResultCard(pcResult);
                    } else {
                        cardHTML += '<p class="text-gray-500 italic">ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯PCç‰ˆã«å­˜åœ¨ã—ã¾ã›ã‚“</p>';
                    }
                    cardHTML += '</div>';

                    // SPç‰ˆ
                    cardHTML += '<div class="border-l-4 border-green-500 pl-4">';
                    cardHTML += '<h4 class="font-semibold text-green-700 mb-2">ğŸ“± SPç‰ˆ</h4>';
                    if (spResult) {
                        cardHTML += createResultCard(spResult);
                    } else {
                        cardHTML += '<p class="text-gray-500 italic">ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯SPç‰ˆã«å­˜åœ¨ã—ã¾ã›ã‚“</p>';
                    }
                    cardHTML += '</div>';

                    cardHTML += '</div>';
                    card.innerHTML = cardHTML;
                    container.appendChild(card);
                });
            } else {
                // å˜ä¸€ãƒ¢ãƒ¼ãƒ‰
                analysisResults.forEach(result => {
                    const card = document.createElement('div');
                    card.className = 'border border-gray-200 rounded-lg p
